<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/google-signin/google-signin.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="shared-styles.html">

<dom-module id="profile-view">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                padding: 10px;
            }

            div.card {
                font-size: 25px;
            }
        </style>
        <iron-ajax
            id="checkAuthToken"
            handle-as="json"
            processData="false"
            on-response="_authTokenSuccess"
            on-error="_authTokenError"
            withCredentials="true">
        </iron-ajax>
        <div class="card">
            <p>google signin necessary to save images to your google drive.</p>
            <google-signin 
                class="flex"
                raised
                width="wide"
                theme="dark" 
                client-id="867389108662-ml3u1clb60k7oqam0bcai4bt207u88j0.apps.googleusercontent.com" 
                scopes="https://www.googleapis.com/auth/drive"
                signed-in="{{signedIn}}">
            </google-signin>
        </div>
    </template>

    <script>
        (function(){
            Polymer({
                is: 'profile-view',
                properties: {
                    activeRoute: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_activeRoute'
                    },
                    signedIn: {
                        type: Boolean,
                        notify: true,
                        observer: '_handleGoogleSignedOut'
                    }
                },
                listeners: {
                    'google-signin-success' : '_googleSignInSuccess',
                    'google-signed-out' : '_handleGoogleSignedOut'
                },
                _activeRoute: function() {

                },
                _googleSignInSuccess: function() {
                    var app = document.querySelector('my-app');
                    app.storeUser(gapi.auth2.getAuthInstance()['currentUser'].get());
                    app.setUser();
                    app.setAuthToken(gapi.auth2.getAuthInstance()['currentUser'].get().Zi.access_token);
                    // console.log(gapi.auth2.getAuthInstance()['currentUser'].get());
                    window.history.pushState({}, null, '/');
                    window.dispatchEvent(new CustomEvent('location-changed'));

                },
                _handleGoogleSignedOut: function() {
                    if (this.signedIn === false) {
                        var app = document.querySelector('my-app');
                        app.removeUser();
                        app.setAuthToken('');
                    }
                },
                _authTokenError: function(e) {
                    document.querySelector('my-app').setAuthToken('');
                    window.history.pushState({}, null, '/profile');
                    window.dispatchEvent(new CustomEvent('location-changed'));
                },
                _authTokenSuccess: function() {
                },
                checkAuthenticationToken: function() {
                    var app = document.querySelector('my-app');
                    if (app.getAuthToken()) {
                        this.$.checkAuthToken.url = 'https://www.googleapis.com/oauth2/v3/tokeninfo?access_token=' + app.getAuthToken();
                        this.$.checkAuthToken.generateRequest();
                    } else {
                        this._authTokenError();
                    }
                }
            });
        })();
    </script>
</dom-module>
